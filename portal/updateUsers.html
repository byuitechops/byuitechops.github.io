<script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-firestore.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyA_I75-CU5_GlNP1QSKvvH8nbYVkaAUgNA",
        authDomain: "techopsportal.firebaseapp.com",
        databaseURL: "https://techopsportal.firebaseio.com",
        projectId: "techopsportal",
        storageBucket: "techopsportal.appspot.com",
        messagingSenderId: "265124430634"
    };
    firebase.initializeApp(config);
    // Initialize Cloud Firestore through Firebase
    var db = firebase.firestore();

    // Disable deprecated features
    db.settings({
        timestampsInSnapshots: true
    });

    // firebase.database().ref('users').once('value').then(function (snap) {
    //     var users = snap.val();
    //     for (key in users) {
    //         // Here is where you put the changes to the users
    //         console.log(key);
    //         var update =
    //             '{"katana": null, "microsoft": null, "monthlyTraining": null, "pathway": null, "proDev": null, "screenSteps": null, "slack": null, "teamDrive": null, "teamDynamix": null, "totStyleGuide": null, "trello": null, "videoIndexing": null, "workDay": null, "brightspace": null, "canvas": null, "canvasStyleGuide": null, "employeeDirectory": null, "equella": null, "firebaseConsole": null}';
    //         update = JSON.parse(update);
    //         firebase.database().ref('users/' + key).update(update);
    //     }
    // })

    var users = [];
    var realSnap = "";

    function pushUsers() {
        firebase.database().ref('users').once('value').then(function (snap) {
            realSnap = snap.val();
            snap = snap.val();
            // console.log(snap);
            for (var name in snap) {
                users.push(name);
                var json = "{"
                json += `"name": "${name}"`;
                for (var title in snap[name]) {
                    if (title == "Admin") {
                        json += `, "admin": ${snap[name][title]}`;
                    }
                    if (title == "Team") {
                        json += `, "team": "${snap[name][title]}"`;
                    }
                    if (title == "TeamLead") {
                        json += `, "teamLead": ${snap[name][title]}`;
                    }
                    if (title == "info") {
                        if (snap[name][title]["phoneNumber"] != undefined) {
                            delete snap[name][title]["phoneNumber"];
                        }
                        if (snap[name][title]["phoneNum"] == undefined) {
                            snap[name][title]["phoneNum"] = null;
                        }
                        json += `, "info": ${JSON.stringify(snap[name][title])}`;
                    }
                }
                json += `, "time": {`;
                json += `"break": ${snap[name]["TimeClock"]["break"]}`;
                json +=
                    `, "breakKey": "${snap[name]["TimeClock"]["breakkey"]}"`;
                json +=
                    `, "check": "${snap[name]["TimeClock"]["check"]}"`;
                json +=
                    `, "checkKey": "${snap[name]["TimeClock"]["timekey"]}"`;
                json += "}"
                json += "}"
                console.log(json);
                json = JSON.parse(json);
                console.log(json);
                db.collection("usersTest").add(json).then(function (docRef) {
                    console.log("Document written with ID: ", docRef.id);
                }).catch(function (error) {
                    console.error("Error adding document:", error);
                });
            }
        });
    }

    function loopUsers() {
        for (var i = 0; i < users.length; i++) {
            var docId = getId(users[i]);
            setTimeout(()=> {
            subCollections(users[i], docId);
            }, 2000);
        }
    }

    function subCollections(name, docId) {
        console.log(docId);

        // Scheduled Time
        var schedule = realSnap[name]["TimeClock"]["ScheduledTime"];
        console.log("Scheduled Time");
        console.log(schedule);
        for (var time in schedule) {
            var sjson = '{';
            var newDate = new Date(time);
            var inTime = new Date('1970-01-01 ' + schedule[time]["Start"]);
            var outTime = new Date('1970-01-01 ' + schedule[time]["End"]);
            var date = (newDate.getFullYear() + "-" + ("0" + (1 + newDate.getMonth())).slice(-2) + "-" +
                ("0" + newDate.getDate()).slice(-2) + " " + ("0" + newDate.getHours()).slice(-2) +
                ":" + ("0" + newDate.getMinutes()).slice(-2) + ":" + ("0" + newDate.getSeconds()).slice(
                    -2));
            sjson += '"in": ';
            sjson += ('"' + ("0" + inTime.getHours()).slice(-2) +
                ":" + ("0" + inTime.getMinutes()).slice(-2) + ":" + ("0" + inTime.getSeconds()).slice(
                    -2) + '", ');
            sjson += '"out": ';
            sjson += ('"' + ("0" + outTime.getHours()).slice(-2) + ":" + ("0" + outTime.getMinutes()).slice(
                    -2) +
                ":" + ("0" + outTime.getSeconds()).slice(-2) + '"');
            sjson += "}";
            // console.log(sjson); 
            // console.log(JSON.parse(sjson)); 
            sjson = JSON.parse(sjson);
            console.log(docId);
            db.collection('usersTest').doc(docId).collection('scheduledTime').doc(date).set(sjson);
        }

        // Hours Worked 
        var hours = realSnap[name]["TimeClock"]["HoursWorked"];
        console.log("Hours Worked");
        for (var time in hours) {
            var hjson = '{';
            var newDate = new Date(time);
            var inTime = new Date('1970-01-01 ' + hours[time]["In"]);
            var outTime =
                new Date('1970-01-01 ' + hours[time]["Out"]);
            var date = (newDate.getFullYear() + "-" + ("0" + (1 + newDate.getMonth())).slice(-2) + "-" +
                ("0" + newDate.getDate()).slice(-2) + " " + ("0" + newDate.getHours()).slice(-2) +
                ":" + ("0" + newDate.getMinutes()).slice(-2) + ":" + ("0" + newDate.getSeconds()).slice(
                    -2));
            hjson += '"in": ';
            hjson += ('"' + ("0" + inTime.getHours()).slice(-2) + ":" + ("0" + inTime.getMinutes()).slice(
                -2) + ":" + ("0" + inTime.getSeconds()).slice(-2) + '", ');
            hjson += '"out":';
            hjson += ('"' + ("0" + outTime.getHours()).slice(-2) + ": " + ("0" + outTime.getMinutes()).slice(
                -2) + ": " + ("0" + outTime.getSeconds()).slice(-2) + '"');
            hjson += "}";
            // console.log(hjson); 
            // console.log(JSON.parse(hjson)); 
            hjson = JSON.parse(hjson);
            console.log(docId);
            db.collection('usersTest').doc(docId).collection('hoursWorked').doc(date).set(hjson)
        }

        // Breaks 
        var breaks = realSnap[name]["TimeClock"]["Breaks"];
        console.log("Breaks");
        for (var time in breaks) {
            var bjson = '{';
            var newDate = new Date(time);
            var inTime = new Date('1970-01-01 ' + breaks[time]["In"]);
            var outTime = new Date('1970-01-01' + breaks[time]["Out"]);
            var date = (newDate.getFullYear() + "-" + ("0" + (1 + newDate.getMonth())).slice(-2) + "-" +
                ("0" + newDate.getDate()).slice(-2) + " " + ("0" + newDate.getHours()).slice(-2) +
                ":" + ("0" + newDate.getMinutes()).slice(-2) + ":" + ("0" + newDate.getSeconds()).slice(
                    -2));
            bjson += '"in": ';
            bjson += ('"' + ("0" + inTime.getHours()).slice(-2) + ":" + ("0" + inTime.getMinutes()).slice(
                -2) + ":" + ("0" + inTime.getSeconds()).slice(-2) + '", ');
            bjson += '"out": ';
            bjson += ('"' + ("0" + outTime.getHours()).slice(-2) + ":" + ("0" + outTime.getMinutes()).slice(
                -2) + ":" + ("0" + outTime.getSeconds()).slice(-2) + '"');
            bjson = bjson + '}';
            // console.log(bjson); 
            // console.log(JSON.parse(bjson));
            bjson = JSON.parse(bjson);
            console.log(docId);
            db.collection('usersTest').doc(docId).collection('breaks').doc(date).set(bjson);
        }
    }

    function getId(name) {
        console.log(name);
        var collectionReference = db.collection('usersTest');
        var query = collectionReference.where('name', '==', name);
        query.get().then(function (querySnapshot) {
            if (querySnapshot.empty) {
                console.log('no documents found');
            } else {
                return querySnapshot.docs[0].id;
            }
        });
    }
</script>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

</body>

</html>