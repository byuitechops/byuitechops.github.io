<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBWv05RlAPUpAts6LNXgG5-wsdhd9jXafg",
            authDomain: "byui-accessability.firebaseapp.com",
            databaseURL: "https://byui-accessability.firebaseio.com",
            projectId: "byui-accessability",
            storageBucket: "byui-accessability.appspot.com",
            messagingSenderId: "275383619900"
        };
        firebase.initializeApp(config);
        // Initialize Cloud Firestore through Firebase
        var db = firebase.firestore();
        const settings = { /* your settings... */
            timestampsInSnapshots: true
        };
        db.settings(settings);

        function downloadFromDB() {
            db.collection("accessibility").orderBy('srcURl').orderBy('title').limit(2).get().then((querySnapshot) => {
                var array = [];
                querySnapshot.forEach((doc) => {
                    array.push(doc.data());
                    console.log(doc.data());
                });
                document.write(JSON.stringify(array));
            });
        }

        function loadJSON1(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'download.json', true);
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    callback(JSON.parse(xobj.responseText));
                }
            };
            xobj.send(null);
        }
        convertData();

        function convertData() {
            loadJSON1(function (array) {
                let csvContent =
                    "Course Code, Title, Priority, Status, SrcURL, DocURL, LmsURL, Transcriber, Copyeditor, Placed, Type, Week, Requestor, Request Date\n";
                for (var i = 0; i < array.length; i++) {
                    if (array[i]['copyeditor'] == undefined) {
                        array[i]['copyeditor'] = "";
                    } else if (array[i]['copyeditor'].includes(',')) {
                        array[i]['copyeditor'] = `"${array[i]['copyeditor']}"`;
                    }

                    if (array[i]['courseCode'] == undefined) {
                        array[i]['courseCode'] = "";
                    } else if (array[i]['courseCode'].includes(',')) {
                        array[i]['courseCode'] = `"${array[i]['courseCode']}"`;
                    }

                    if (array[i]['docURL'] == undefined) {
                        array[i]['docURL'] = "";
                    } else if (array[i]['docURL'].includes(',')) {
                        array[i]['docURL'] = `"${array[i]['docURL']}"`;
                    }
                    if (array[i]['placed'] == undefined) {
                        array[i]['placed'] = false;
                    }
                    if (array[i]['priority'] == undefined) {
                        array[i]['priority'] = "";
                    } else if (array[i]['priority'].includes(',')) {
                        array[i]['priority'] = `"${array[i]['priority']}"`;
                    }
                    if (array[i]['requestDate'] == undefined) {
                        array[i]['requestDate'] = "";
                    } else if (typeof array[i]['requestDate'] == "object") {
                        array[i]['requestDate'] = Date(array[i]['requestDate']['nanoseconds']);
                    }
                    if (array[i]['requestor'] == undefined) {
                        array[i]['requestor'] = "";
                    } else if (array[i]['requestor'].includes(',')) {
                        array[i]['requestor'] = `"${array[i]['requestor']}"`;
                    }
                    if (array[i]['srcURl'] == undefined) {
                        array[i]['srcURL'] = "";
                    } else {
                        array[i]['srcURL'] = array[i]['srcURl'];
                        delete array[i]['srcURl'];
                        if (array[i]['srcURL'].includes(',')) {
                        array[i]['srcURL'] = `"${array[i]['srcURL']}"`;
                        }
                    }
                    if (array[i]['status'] == undefined) {
                        array[i]['status'] = "";
                    } else if (array[i]['status'].includes(',')) {
                        array[i]['status'] = `"${array[i]['status']}"`;
                    }
                    if (array[i]['title'] == undefined) {
                        array[i]['title'] = "";
                    } else if (array[i]['title'].includes(',')) {
                        array[i]['title'] = `"${array[i]['title']}"`;
                    }
                    if (array[i]['transcriber'] == undefined) {
                        array[i]['transcriber'] = "";
                    } else if (array[i]['transcriber'].includes(',')) {
                        array[i]['transcriber'] = `"${array[i]['transcriber']}"`;
                    }
                    if (array[i]['type'] == undefined) {
                        array[i]['type'] = "";
                    } else if (array[i]['type'].includes(',')) {
                        array[i]['type'] = `"${array[i]['type']}"`;
                    }
                    if (array[i]['week'] == undefined) {
                        array[i]['week'] = "";
                    } else if (array[i]['week'].includes(',')) {
                        array[i]['week'] = `"${array[i]['week']}"`;
                    }
                    let row =
                        `${array[i]['courseCode']},${array[i]['title']},${array[i]['priority']},${array[i]['status']},${array[i]['srcURL']},${array[i]['docURL']},${array[i]['lmsURL']},${array[i]['transcriber']},${array[i]['copyeditor']},${array[i]['placed']},${array[i]['type']},${array[i]['week']},${array[i]['requestor']},${array[i]['requestDate']}`;
                    csvContent += row + "\r\n";
                }
                // console.log(csvContent);
                var blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8'});
                // var encodedUri = encodeURI(csvContent);
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "my_data.csv");
                link.innerHTML = "Click Here to download";
                document.body.appendChild(link); // Required for FF

                // link.click();
            })
        }
    </script>
</head>

<body>

</body>

</html>